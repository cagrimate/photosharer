name: Twitter Botu Ã‡alÄ±ÅŸtÄ±r

on:
  schedule:
    # --- Ä°NSAN GÄ°BÄ° ZAMANLAMA STRATEJÄ°SÄ° ---
    # GitHub Actions UTC (Coordinated Universal Time) kullanÄ±r.
    # TÃ¼rkiye (TRT) = UTC + 3 saattir.
    # Hedef: TR saatiyle sabah 08:00 ile gece 00:00 arasÄ± Ã§alÄ±ÅŸsÄ±n (Uyku vakti: 00:00 - 08:00).
    # UTC KarÅŸÄ±lÄ±ÄŸÄ±: Sabah 05:00 ile AkÅŸam 21:00 arasÄ±.
    
    # "5-21/1" -> 05:00'dan 21:00'a kadar her saat baÅŸÄ± Ã§alÄ±ÅŸÄ±r. (Toplam ~17 tetikleme)
    # DakikayÄ± '13' gibi rastgele bir sayÄ± seÃ§tim ki tam saat baÅŸÄ±nda olmasÄ±n.
    - cron: "13 7-23 * * *"
    
  workflow_dispatch: # Manuel tetikleme iÃ§in

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    concurrency:
      group: twitter-bot
      cancel-in-progress: false

    steps:
      - name: Kodu Ã§ek
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Python kur
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        run: |
          python -m pip install --upgrade pip
          pip install requests tweepy python-dotenv google-genai schedule

      # --- KRÄ°TÄ°K EKLEME: RASTGELE GECÄ°KME (JITTER) ---
      # Botun tam 13 geÃ§e Ã§alÄ±ÅŸmasÄ±nÄ± engeller.
      # 1 saniye ile 1800 saniye (30 dakika) arasÄ±nda rastgele bekler.
      # BÃ¶ylece bir tweet 14:15'te atÄ±lÄ±rken diÄŸeri 15:40'ta atÄ±labilir.
      - name: ğŸ² Ä°nsan Taklidi - Rastgele Bekleme SÃ¼resi
        shell: bash
        run: |
          echo "ğŸ¤– Bot tetiklendi ama insan gibi gÃ¶rÃ¼nmek iÃ§in rastgele bekliyor..."
          # 0 ile 1800 saniye (30 dk) arasÄ±nda rastgele sayÄ± Ã¼ret
          DELAY=$((RANDOM % 1800)) 
          echo "â³ $DELAY saniye (yaklaÅŸÄ±k $((DELAY / 60)) dakika) beklenecek."
          sleep $DELAY

      - name: Botu Ã‡alÄ±ÅŸtÄ±r ve PaylaÅŸ
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONSUMER_KEY: ${{ secrets.CONSUMER_KEY }}
          CONSUMER_SECRET: ${{ secrets.CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
        run: |
          # 'once' argÃ¼manÄ±, Python kodunun iÃ§indeki schedule dÃ¶ngÃ¼sÃ¼nÃ¼ kÄ±rÄ±p
          # tek sefer Ã§alÄ±ÅŸÄ±p kapanmasÄ±nÄ± saÄŸlamalÄ±dÄ±r.
          python pexels_otomasyon.py once

      - name: paylasilan_idler.txt deÄŸiÅŸtiyse commit et
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet -- paylasilan_idler.txt; then
            echo "ğŸ”„ ID dosyasÄ± gÃ¼ncellenmiÅŸ, commit ediliyor..."
            git add paylasilan_idler.txt
            git commit -m "Update shared Pexels IDs [skip ci]" || echo "Commit gerekmedi"
            git push
          else
            echo "â„¹ï¸ ID dosyasÄ±nda deÄŸiÅŸiklik yok, commit yok."
          fi
